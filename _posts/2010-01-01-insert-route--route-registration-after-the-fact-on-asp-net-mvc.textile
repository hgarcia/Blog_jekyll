---
layout: post
title: Insert route, route registration after the fact on ASP.NET MVC
summary: Kazi Manzur Rashid has a post about registering Areas dynamically after the registration of other routes and the problems this has since the order the routes are registered is very important. Go read his post and come back for a possible solution...
---
Kazi Manzur Rashid has a post about registering Areas dynamically after the registration of other routes and the problems this has since the order the routes are registered is very important. Go <a href="http://weblogs.asp.net/rashid/archive/2009/12/30/asp-net-mvc-2-and-why-dynamic-area-is-not-supported.aspx" target="_blank">read his post</a> and come back for a possible solution to the problem.
 Ok, based on his post I decided to try to implement exactly what he is looking for. After poking around with reflector and brushing up my Reflection skills I came up with a first implementation that does the trick.
<pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">  1:     <span style="color: #0000ff">public</span> <span style="color: #0000ff">static</span> <span style="color: #0000ff">class</span> RoutCollectionExtension
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">  2:     {
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">  3:         <span style="color: #0000ff">public</span> <span style="color: #0000ff">static</span> RouteCollection AddArea(<span style="color: #0000ff">this</span> RouteCollection routes, <span style="color: #0000ff">string</span> routeName, Route newRoute)
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">  4:         {
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">  5:             var fieldInfo =  routes.GetType()
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">  6:                 .GetField("<span style="color: #8b0000">_namedMap</span>", BindingFlags.Public | BindingFlags.NonPublic | BindingFlags.Instance);
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">  7: 
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">  8:             var dict = fieldInfo.GetValue(routes);
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">  9:             dict.GetType()
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px"> 10:                 .GetMethod("<span style="color: #8b0000">Add</span>", BindingFlags.Public | BindingFlags.Instance)
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px"> 11:                 .Invoke(dict,<span style="color: #0000ff">new</span> <span style="color: #0000ff">object</span>[]{routeName,newRoute});
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px"> 12: 
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px"> 13:             fieldInfo.SetValue(routes,dict);
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px"> 14: 
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px"> 15:             routes.GetType()
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px"> 16:                 .GetMethod("<span style="color: #8b0000">InsertItem</span>", BindingFlags.NonPublic | BindingFlags.Instance)
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px"> 17:                 .Invoke(routes, <span style="color: #0000ff">new</span> <span style="color: #0000ff">object</span>[] { 0, newRoute });
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px"> 18: 
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px"> 19:             <span style="color: #0000ff">return</span> routes;
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px"> 20:         }
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px"> 21:     }</pre></pre>
After posted this solution as a comment on Kazi’s post I decided to polish this a little more and to actually provide a similar API as the MapRoute extension from the MVC framework. The idea is to provide a set of InsertRoute and InsertRouteAfter. 

So for the InsertRoute, this is the final code:
<pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">  1:     <span style="color: #0000ff">public</span> <span style="color: #0000ff">static</span> <span style="color: #0000ff">class</span> RoutCollectionExtension
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">  2:     {
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">  3:         <span style="color: #0000ff">public</span> <span style="color: #0000ff">static</span> <span style="color: #0000ff">void</span> InsertRoute(<span style="color: #0000ff">this</span> RouteCollection routes, <span style="color: #0000ff">int</span> index, <span style="color: #0000ff">string</span> routeName, Route newRoute)
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">  4:         {
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">  5:             var fieldInfo =  routes.GetType()
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">  6:                 .GetField("<span style="color: #8b0000">_namedMap</span>", BindingFlags.Public | BindingFlags.NonPublic | BindingFlags.Instance);
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">  7: 
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">  8:             var dict = fieldInfo.GetValue(routes);
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">  9:             dict.GetType()
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px"> 10:                 .GetMethod("<span style="color: #8b0000">Add</span>", BindingFlags.Public | BindingFlags.Instance)
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px"> 11:                 .Invoke(dict,<span style="color: #0000ff">new</span> <span style="color: #0000ff">object</span>[]{routeName,newRoute});
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px"> 12: 
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px"> 13:             fieldInfo.SetValue(routes,dict);
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px"> 14: 
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px"> 15:             routes.GetType()
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px"> 16:                 .GetMethod("<span style="color: #8b0000">InsertItem</span>", BindingFlags.NonPublic | BindingFlags.Instance)
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px"> 17:                 .Invoke(routes, <span style="color: #0000ff">new</span> <span style="color: #0000ff">object</span>[] { index, newRoute });
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px"> 18:         }
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px"> 19: 
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px"> 20: 
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px"> 21:         <span style="color: #0000ff">public</span> <span style="color: #0000ff">static</span> Route InsertRoute(<span style="color: #0000ff">this</span> RouteCollection routes, <span style="color: #0000ff">int</span> index, <span style="color: #0000ff">string</span> name, <span style="color: #0000ff">string</span> url)
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px"> 22:         {
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px"> 23:             <span style="color: #0000ff">return</span> routes.InsertRoute(index, name, url, <span style="color: #0000ff">null</span>, <span style="color: #0000ff">null</span>);
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px"> 24:         }
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px"> 25: 
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px"> 26:         <span style="color: #0000ff">public</span> <span style="color: #0000ff">static</span> Route InsertRoute(<span style="color: #0000ff">this</span> RouteCollection routes, <span style="color: #0000ff">int</span> index, <span style="color: #0000ff">string</span> name, <span style="color: #0000ff">string</span> url, <span style="color: #0000ff">object</span> defaults)
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px"> 27:         {
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px"> 28:             <span style="color: #0000ff">return</span> routes.InsertRoute(index, name, url, defaults, <span style="color: #0000ff">null</span>);
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px"> 29:         }
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px"> 30: 
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px"> 31:         <span style="color: #0000ff">public</span> <span style="color: #0000ff">static</span> Route InsertRoute(<span style="color: #0000ff">this</span> RouteCollection routes, <span style="color: #0000ff">int</span> index, <span style="color: #0000ff">string</span> name, <span style="color: #0000ff">string</span> url, <span style="color: #0000ff">string</span>[] namespaces)
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px"> 32:         {
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px"> 33:             <span style="color: #0000ff">return</span> routes.InsertRoute(index, name, url, <span style="color: #0000ff">null</span>, <span style="color: #0000ff">null</span>, namespaces);
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px"> 34:         }
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px"> 35: 
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px"> 36:         <span style="color: #0000ff">public</span> <span style="color: #0000ff">static</span> Route InsertRoute(<span style="color: #0000ff">this</span> RouteCollection routes, <span style="color: #0000ff">int</span> index,  <span style="color: #0000ff">string</span> name, <span style="color: #0000ff">string</span> url, 
<blockquote><span style="color: #0000ff">object</span> defaults, <span style="color: #0000ff">object</span> constraints)

</blockquote></pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px"> 37:         {
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px"> 38:             <span style="color: #0000ff">return</span> routes.InsertRoute(index, name, url, defaults, constraints, <span style="color: #0000ff">null</span>);
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px"> 39:         }
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px"> 40: 
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px"> 41:         <span style="color: #0000ff">public</span> <span style="color: #0000ff">static</span> Route InsertRoute(<span style="color: #0000ff">this</span> RouteCollection routes, <span style="color: #0000ff">int</span> index,  <span style="color: #0000ff">string</span> name, <span style="color: #0000ff">string</span> url, 
<blockquote><span style="color: #0000ff">object</span> defaults, <span style="color: #0000ff">string</span>[] namespaces)

</blockquote></pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px"> 42:         {
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px"> 43:             <span style="color: #0000ff">return</span> routes.InsertRoute(index, name, url, defaults, <span style="color: #0000ff">null</span>, namespaces);
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px"> 44:         }
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px"> 45: 
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px"> 46:         <span style="color: #0000ff">public</span> <span style="color: #0000ff">static</span> Route InsertRoute(<span style="color: #0000ff">this</span> RouteCollection routes, <span style="color: #0000ff">int</span> index, <span style="color: #0000ff">string</span> name, <span style="color: #0000ff">string</span> url, <span style="color: #0000ff">object</span> defaults, 
<blockquote><span style="color: #0000ff">object</span> constraints, <span style="color: #0000ff">string</span>[] namespaces)

</blockquote></pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px"> 47:         {
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px"> 48:             <span style="color: #0000ff">if</span> (routes == <span style="color: #0000ff">null</span>)
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px"> 49:             {
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px"> 50:                 <span style="color: #0000ff">throw</span> <span style="color: #0000ff">new</span> ArgumentNullException("<span style="color: #8b0000">routes</span>");
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px"> 51:             }
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px"> 52:             <span style="color: #0000ff">if</span> (url == <span style="color: #0000ff">null</span>)
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px"> 53:             {
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px"> 54:                 <span style="color: #0000ff">throw</span> <span style="color: #0000ff">new</span> ArgumentNullException("<span style="color: #8b0000">url</span>");
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px"> 55:             }
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px"> 56:             var item = <span style="color: #0000ff">new</span> Route(url, <span style="color: #0000ff">new</span> MvcRouteHandler())
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px"> 57:                              {
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px"> 58:                                  Defaults = <span style="color: #0000ff">new</span> RouteValueDictionary(defaults),
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px"> 59:                                  Constraints = <span style="color: #0000ff">new</span> RouteValueDictionary(constraints),
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px"> 60:                                  DataTokens = <span style="color: #0000ff">new</span> RouteValueDictionary()
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px"> 61:                              };
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px"> 62:             <span style="color: #0000ff">if</span> ((namespaces != <span style="color: #0000ff">null</span>) &amp;amp;&amp;amp; (namespaces.Length &amp;gt; 0))
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px"> 63:             {
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px"> 64:                 item.DataTokens["<span style="color: #8b0000">Namespaces</span>"] = namespaces;
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px"> 65:             }
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px"> 66:             routes.InsertRoute(index, name, item);
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px"> 67:             <span style="color: #0000ff">return</span> item;
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px"> 68:         }
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px"> 69:     }</pre></pre>
The problem with this is that you probably don’t know the index of the routes and those index will change with each route that get’s registered. So InsertRouteAfter is better since we can insert a route after another route by name. The code is very simple, I won’t display all the overloads just the actual implementation.
<pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">  1:         <span style="color: #0000ff">public</span> <span style="color: #0000ff">static</span> <span style="color: #0000ff">void</span> InsertRouteAfter(<span style="color: #0000ff">this</span> RouteCollection routes, <span style="color: #0000ff">string</span> nameOfExistingRoute, <span style="color: #0000ff">string</span> nameOfRouteToInsert, Route newRoute)
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">  2:         {
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">  3:             var fieldInfo = routes.GetType()
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">  4:                 .GetField("<span style="color: #8b0000">_namedMap</span>", BindingFlags.Public | BindingFlags.NonPublic | BindingFlags.Instance);
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">  5: 
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">  6:             var dict = fieldInfo.GetValue(routes);
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">  7:             dict.GetType()
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">  8:                 .GetMethod("<span style="color: #8b0000">Add</span>", BindingFlags.Public | BindingFlags.Instance)
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px">  9:                 .Invoke(dict, <span style="color: #0000ff">new</span> <span style="color: #0000ff">object</span>[] { nameOfRouteToInsert, newRoute });
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px"> 10: 
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px"> 11:             var existingRoute = dict.GetType()
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px"> 12:                 .GetProperty("<span style="color: #8b0000">Item</span>")
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px"> 13:                 .GetValue(dict, <span style="color: #0000ff">new</span>[] {nameOfExistingRoute});
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px"> 14: 
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px"> 15:             fieldInfo.SetValue(routes, dict);
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px"> 16: 
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px"> 17:             var index = routes.GetType()
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px"> 18:                 .GetMethod("<span style="color: #8b0000">IndexOf</span>", BindingFlags.Public | BindingFlags.NonPublic | BindingFlags.Instance)
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px"> 19:                 .Invoke(routes, <span style="color: #0000ff">new</span>[] {existingRoute});
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px"> 20: 
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px"> 21:             index = (<span style="color: #0000ff">int</span>) index + 1;
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px"> 22: 
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px"> 23:             routes.GetType()
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px"> 24:                 .GetMethod("<span style="color: #8b0000">InsertItem</span>", BindingFlags.NonPublic | BindingFlags.Instance)
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px"> 25:                 .Invoke(routes, <span style="color: #0000ff">new</span>[] { index, newRoute });
</pre><pre style="background-color: #ffffff; margin: 0em; width: 100%; font-family: consolas,'Courier New',courier,monospace; font-size: 12px"> 26:         }</pre></pre>
<h3>Warning!!!</h3>
If you decide to use this code make sure that you have tests in place since we are relying in things like the name of a internal field that can be changed without affecting the public API so this extensions are fragile from that point of view. Besides that, reflection is slow, but since route registration should happens only once per application I’m not worry about that part. 



<strong><font size="2"></font></strong>
<a href="http://dotnetshoutout.com/The-Dynamic-Programmer-Insert-route-route-registration-after-the-fact-on-ASPNET-MVC" rev="vote-for"><img style="border-right-width: 0px; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px" alt="Shout it" src="http://dotnetshoutout.com/image.axd?url=http%3A%2F%2Fblog.dynamicprogrammer.com%2F2010%2F01%2F02%2FInsertRouteRouteRegistrationAfterTheFactOnASPNETMVC.aspx"></a>